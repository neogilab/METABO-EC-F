---
title: "Bublle plot"
output: html_notebook
---

# Parse IPA output

ipa <- read.delim("/home/mikov/Desktop/Proteomics/data/IPA/IPA pathway KI_salmon_2.txt")
ipa <- read.delim("/home/mikov/Desktop/Proteomics/data/IPA/IPA pathway Mayo_2.txt")

ipa <- read.delim("data/IPA/NormDE_Limma_12M.txt")
ipa <- read.delim("data/IPA/TMT_EdgeR_12M.txt")
ipa <- read.delim("data/IPA/TMT_EdgeR_2M.txt")

ipa <- read.delim("data/IPA_output/2M_liver_IPA_output.txt")
ipa <- read.delim("data/IPA_output/12_M_liver_IPA_output.txt")

```{r}
library(ggplot2)
library(dplyr)
```

```{r}
name_ana <- "dGK_mice_2M_liver"
ipa <- read.delim("data/IPA_output/2M_liver_IPA_output.txt")
```

```{r}
ipa <- ipa[!ipa$z.score == "NaN",]
ipa$nb_genes <-NA
```

```{r}
for (i in 1:nrow(ipa)){
  x <- paste0(ipa$Molecules[i], collapse=" ")
  y <- as.list(strsplit(x, ",")[[1]])
  ipa[i,6] <- length(y)
}
```

```{r}
ipa$significant <- NA
```

# attribute up or down according to logFC

```{r}
for (i in 1:nrow(ipa)){
  if(ipa[i,4] > 0){
    ipa[i,7] <- "pos"
  }else{
    ipa[i,7] <- "neg"
  }
  if(ipa[i,2] < -log(0.05)){
    ipa[i,7] <- "NS"
  }

}
```

```{r}
top_genes <- ipa[(ipa$z.score > 0.8) | (ipa$z.score < - 0.8), ]
top_genes <- top_genes[(top_genes$X.log.p.value. > 3), ]

dim(top_genes)
# remove label for proteins with  - 1 < logFoldChange < 1
for (nb_row in 1:nrow(ipa)){
  if (ipa[nb_row, 1] %in% top_genes$Ingenuity.Canonical.Pathways){
    }else{
      ipa[nb_row, 1] <- NA
  }
}
```
```{r}
library(ggrepel)
fill <- c("#5CB3FF", "#C0C0C0","#b30000")
```

```{r}
p6 <- ggplot(ipa, aes(x = z.score, y = X.log.p.value.,  size = nb_genes, fill = significant,  label = Ingenuity.Canonical.Pathways)) +
        #geom_text(check_overlap = TRUE, size = 3, nudge_y = 0.7, vjust="inward",hjust="inward") +
        geom_point(shape = 21, alpha = 0.5, colour = "transparent")+ scale_size_area(max_size = 10) + 
  geom_text_repel(size = 3.5, min.segment.length = unit(0.1, "lines"),nudge_y = 2, vjust="inward",hjust="inward",force = 10)+
        ggtitle("Importants terms enriched according to z-score, pvalue and number of genes") +
            labs(x = "z-score", y = "-log(pvalue)")+ 
        scale_fill_manual(values = fill)
```

```{r}
p6

path_fig <- paste0("results/IPA/figures/", name_ana, "_bubble_plot.pdf")
dev.copy(pdf,path_fig)
dev.off()
```


# preparation of cytoscape input
# table : nodes
# node + type (gene / term)

# table: edges :
# gene + term x
```{r}
head(top_genes)
```

```{r}
top_ipa <- ipa[complete.cases(ipa$Ingenuity.Canonical.Pathways),]
```


```{r}
table_edges <- data.frame(Node_1 = NA, Node_2 = NA, Type = NA)
```


```{r}
for (i in 1:nrow(top_ipa)){
  x <- paste0(ipa$Molecules[i], collapse=" ")
  y <- as.list(strsplit(x, ",")[[1]])
  path <- rep(top_ipa[i, 1], length(y))
  a <-do.call(rbind.data.frame, y)
  names(a)<- "Node_1"
  a <-cbind(a, path, path)
  names(a)[2]<- "Node_2"
  names(a)[3]<- "Type"
  table_edges <-rbind(table_edges, a)
}
```

```{r}
head(table_edges)
table_edges[1] <- mutate_all(table_edges[1], funs(toupper))
head(table_edges)
```

```{r}
table_nodes <- data.frame(Items = NA, Type = NA)
```

table_nodes[-1] <- mutate_all(table_nodes[-1], funs(toupper))
table_edges[c(-2, -3)] <- mutate_all(table_edges[c(-2, -3)], funs(toupper))

```{r}
path <- top_ipa$Ingenuity.Canonical.Pathways
genes <- table_edges$Node_1
genes <- genes[!duplicated(genes)]



table_path <- data.frame(Item = path, Type = "pathway")
table_genes <- data.frame(Item = genes, Type = "gene")
table_genes <- mutate_all(table_genes, funs(toupper))

table_nodes<- rbind(table_path, table_genes)
```

```{r}
table_nodes <- table_nodes[complete.cases(table_nodes),]
table_edges <- table_edges[complete.cases(table_edges),]
```

```{r}
library(dplyr)
```

```{r}
names(table_nodes)[1] <-  "Node_1"
names(table_edges) <-  c("Node_1", "Node_2", "Group")
```

```{r}
table_nodes <- merge(table_nodes, table_edges[,c(1,3)], by = "Node_1")
head(table_nodes)
```

```{r}
pathway <- data.frame(Node_1 = top_genes$Ingenuity.Canonical.Pathways,
                      Type = "PATH",
                      Group = top_genes$Ingenuity.Canonical.Pathways)
```

```{r}
table_nodes <- rbind(table_nodes, pathway)
```

```{r}
path_nodes <- paste0("results/IPA/", name_ana, "/table_nodes.txt")
write.table(table_nodes, file = path_nodes, sep = ",", col.names = NA,
            qmethod = "double")
```

# NB : merge string and table edge


/home/mikov/Desktop/Proteomics/data/string/string_interactions_2M_TMM_2.tsv
/home/mikov/Desktop/Proteomics/data/string/string_interactions_12M_TMM_2.tsv
/home/mikov/Desktop/Proteomics/data/string/string_interactions_normDE_limma_M12_2.csv
/home/mikov/Desktop/Proteomics/results/IPA/KI_salmon/string_interactions.tsv
/home/mikov/Desktop/Proteomics/results/IPA/Mayo/string_interactions(1).tsv

```{r}
string_2M_TMM <- read.delim("data/string/string_interactions_2M_TMM_2.tsv")
string_12M_TMM <- read.delim("data/string/string_interactions_12M_TMM_2.tsv")
string_12M_qt <- read.delim("data/string/string_interactions_normDE_limma_M12_2.csv")
string_salmon <- read.delim("results/IPA/KI_salmon/string_interactions.tsv")
string_mayo <- read.delim("results/IPA/Mayo/string_interactions(1).tsv")
```

```{r}
names(string_mayo)
```

```{r}
library(dplyr)
string <- select(string_mayo, X.node1, node2, node1_string_internal_id)
names(string) <-  c("Node_1", "Node_2", "Group") 
string$Group <- "gene-gene"
```

```{r}
table_edges <- rbind(string, table_edges)
```

```{r}
head(table_edges)
```
```{r}
head(table_nodes)
```

# save everyone
```{r}
path_edges <- paste0("results/IPA/", name_ana, "/table_edges.txt")

write.table(table_edges, file = path_edges, sep = ",",
            qmethod = "double", row.names = FALSE)

```




